# module to build benchmarks
# should create folder structure
import os
import shutil
import requests
from datasets import load_dataset
# from pathlib import Path # ???


### Create benchmark skeleton
def build_dir(bench_path):
    '''
    Create benchmrk skeleton 

    Parameters:
    -----------
    bench_path: str
        The path to the benchmark folder. This folder will be created if it does not exist.

    Returns:
    --------
    
    '''
    
    os.mkdir(bench_path)
    # Create a benchmarks folder with tasks in them
    tasks_path = os.path.join(bench_path, "benchmarks")
    os.mkdir(tasks_path)
    log_path = os.path.join(bench_path, "logs")
    os.mkdir(log_path)

### Generate an about path from the description of the user 
def create_about(bench_name, bench_path, text):
    about_path = os.path.join(bench_path, "about.md")
    about_text= f"""
    # {bench_name}
    {text}

    Generated by BenchTools
    """
    with open(about_path, 'w') as file:
        file.write(about_text)

### Initialize git repository
def init_repo(bench_path):
    '''
    Initialize the benchmark folder as git repo with gitiginore for python 

    Parameters:
    -----------
    bench_path: str
        The path to the benchmark folder
    '''
    current_dir = os.getcwd()
    os.chdir(bench_path)
    try:
        os.system("git init . -q")
        os.system("git branch -m main")
    except:
        print("git might not be initialized in your system. Please run \"git init . \" when setup")
    # Get python gitignore template and create .gitignore
    ignore_text = requests.get("https://raw.githubusercontent.com/github/gitignore/refs/heads/main/Python.gitignore")
    if ignore_text.status_code == 200:
        with open(".gitignore", 'a') as f:
            f.write(ignore_text.text)
    os.chdir(current_dir)


# Create a benchmarks folder with tasks in them
def setup_task(tasks_path: str, task_name: str, task_path: str):

    print(f"Setting up {task_name}...", end='')
    task_folder = os.path.join(tasks_path, task_name)
    os.mkdir(task_folder) # TODO: check if folder exists and handle

    if task_path.startswith('openai'):
        download_dataset(task_folder, task_path)
        print("Success")
        return


    # Path could be absolute or relative, check and work accordingly
    if not task_path.startswith('/'):
        if task_path.startswith('./'):
            # TODO: Path could have one or more `../` use relpath to fix this block 
            task_path = task_path[2:]
        task_path = os.path.join(os.getcwd(), task_path)
        # print(f" path {task_path}\n\n") # Debugging
    
    #  could be a single file or a folder check and work accordignly
    if os.path.isdir(task_path):
        for sub in os.listdir(task_path):
            shutil.copy2(os.path.join(task_path, sub), task_folder)
    else:
        shutil.copy2(task_path, task_folder)
    print("Success")

def download_dataset(task_folder: str, hf_path: str):
    with open(os.path.join(task_folder, 'task.txt'), 'w') as f:
        f.write('{p}')

    dataset = load_dataset(hf_path)
    dataset_test = dataset['test']
    
    with open(os.path.join(task_folder, 'values.csv'), 'w') as f:
        f.write('p,res')
        for row in dataset_test:
            prompt = row['prompt']
            answer = row['canonical_solution']
            f.write(f"{prompt,answer}")


