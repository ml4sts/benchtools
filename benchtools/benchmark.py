# module to build benchmarks
# should create folder structure
import os
import shutil
import requests
import yaml
# from pathlib import Path # ???


about_template = """# {bench_name}

{text}

Generated by BenchTools
"""

class Bench():
    '''
        Benchmark with multiple tasks


    Attributes
    ----------
    bench_name : str
        Name of the benchmark.
    bench_path: str
        Path to where the benchmark folder and all its content reside
    task_folder:
        Path to tasks folder insise benchmark folder
    log folder:
        Path to logs folder inside benchmark folder
    tasks: list of Task objects
        
    is_built: bool

    Methods
    -------
        Build the benchmark directory.
    add_task()
        Add new tasks to the benchmark
    run()
        Run one task or all tasks of the benchmark.
    '''
    def __init__(self, name, path='.', concept = None, tasks=[]):
        '''
        Initialize the benchmark object with the name and path to the benchmark folder.

        Parameters:
        -----------
        name: str
            name of the benchmark will be used for folder
        path: str or buffer
            path where the benchmark will be stored 
        
        tasks: list of Task objects
            list of tasks to be included in the benchmark. Each task should be an instance of the
        
        '''
        # load tasks from file structre and instantiate task objects for each, store those in a list.
        #    loading will 
        self.display_name = name.strip()
        self.concept  = concept if concept else f'a benchmark about {name.strip()}'
        self.bench_name = name.strip().replace(" ", "_").lower()
        self.base_path = path
        self.bench_path = os.path.join(path, self.bench_name)
        self.tasks_folder = os.path.join(self.bench_path, 'tasks')
        self.tasks = tasks # initialize a task object for each task.
        self.written = os.path.exists(self.bench_path)

    @classmethod
    def load(cls, bench_path):
        '''
        Load a benchmark from a given path. The path should point to the benchmark folder.

        Parameters:
        -----------
        bench_path: str
            The path to the benchmark folder. The folder should contain the about.md file, tasks folder and logs folder.

        Returns:
        --------
        Bench
            An instance of the Bench class with the loaded benchmark.
        '''
        if not os.path.exists(bench_path):
            raise ValueError("The passed path doesn't exist.")
        
        task_folder = os.path.join(bench_path, 'tasks')
        
        with open(os.path.join(bench_path, 'info.yml'), 'r') as f:
            info = yaml.safe_load(f)

        task_list = os.listdir(task_folder)
        tasks = []
        for task in task_list:
            # load the tasks
            task_path = os.path.join(task_folder, task)
            content = os.listdir(task_path)
            # TODO: Look at content to create Task objects and add them to tasks

        bench = cls(info['bench_name'], bench_path, info['concept'], tasks)
        return bench
        

    def initialize_dir(self, no_git=False):
        '''
        write out the benchmark folder initially
        
        Parameters:
        -----------
        about_text: str
            description of the benchmark to be included in the about.md file
        no_git: bool
            whether to initialize a git repository in the benchmark folder
        new_tasks: list of tuples (task_name, task_source)
            list of tasks to be added to the benchmark. Each task is represented as a tuple containing

        Returns:
        --------        
        self.built : bool
            True if the benchmark was successfully built, False otherwise
        '''

        # Create benchmark skeleton 
        os.mkdir(self.bench_path)
        # Create a benchmarks folder with tasks in them
        tasks_path = os.path.join(self.bench_path, "tasks")
        os.mkdir(tasks_path)
        log_path = os.path.join(self.bench_path, "logs") # Do we want a log dir?
        os.mkdir(log_path) # Do we want a log dir?

        # Create about.md
        about_path = os.path.join(self.bench_path, "about.md")
        if self: # if self.concept?
            about_body = f"*{self.concept}*"
        about_text= about_template.format(bench_name=self.bench_name, 
                                           text = about_body)
        with open(about_path, 'w') as file:
            file.write(about_text)

        # Initialize a git repo
        if not no_git:
            self.init_repo(self.bench_path)

        for task_name, task_source in self.tasks: 
            self.add_task(task_name, task_source)

        self.write()    
        self.written = True
        return self.written


    def write(self):
        info = {'bench_name': self.bench_name, 
                'concept': self.concept, 
                'bench_path': self.bench_path, 
                'tasks': self.tasks}
        with open(os.path.join(self.bench_path, 'info.yml'), 'w') as f:
            yaml.dump(info, f)

        # likely also writ the tasks and the about, if need to be updated

    
    def write_tasks(self):
        for task in self.tasks:
            task.write(self.tasks_folder)
        

    ### Initialize git repository
    def init_repo(self, bench_path):
        '''
        Initialize the benchmark folder as git repo with gitiginore for python 

        Parameters:
        -----------
        bench_path: str
            The path to the benchmark folder
        '''
        current_dir = os.getcwd()
        os.chdir(bench_path)
        try:
            os.system("git init . -q")
            os.system("git branch -m main")
        except:
            print("git might not be initialized in your system. Please run \"git init . \" when setup")
        # Get python gitignore template and create .gitignore
        ignore_text = requests.get("https://raw.githubusercontent.com/github/gitignore/refs/heads/main/Python.gitignore")
        if ignore_text.status_code == 200:
            with open(".gitignore", 'a') as f:
                f.write(ignore_text.text)
        os.chdir(current_dir)


    def add_task(self, task_name, task_source):
        # TODO: Look at content to create Task objects and add them to tasks
        # setup_task(self.tasks_folder, task_name, task_source))

        # self.tasks.append(task)
        continue

    def run(self, runner):
        for task in self.tasks():
            self.run_task(task, runner)

    def run_task(self, task, runner): 
        task.run(runner)


